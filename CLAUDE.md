# Claude Code Instructions

## –Ø–∑—ã–∫ –æ–±—â–µ–Ω–∏—è
–í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

## –ü—Ä–æ–µ–∫—Ç
Idle Chronicle ‚Äî –º–æ–±–∏–ª—å–Ω—ã–π –∫–ª–∏–∫–µ—Ä-RPG –¥–ª—è Telegram Mini App —Å L2-—Å—Ç–∏–ª–µ–º.

## –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
**–ü—Ä–∏ –∫–∞–∂–¥–æ–º –∫–æ–º–º–∏—Ç–µ –æ–±–Ω–æ–≤–ª—è–π –≤–µ—Ä—Å–∏—é –≤ constants.ts!**
```typescript
// apps/web/src/components/game/constants.ts
export const APP_VERSION = 'v1.X.XX';  // –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Ñ–∏–∫—Å–µ
```

–§–æ—Ä–º–∞—Ç –≤–µ—Ä—Å–∏–∏: `v{major}.{minor}.{patch}`
- **major** ‚Äî –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- **minor** ‚Äî –Ω–æ–≤—ã–µ —Ñ–∏—á–∏
- **patch** ‚Äî –±–∞–≥-—Ñ–∏–∫—Å—ã

## –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
- Frontend: Next.js 14, TypeScript, Phaser 3
- Backend: server.js (Node.js + Socket.io)
- Database: PostgreSQL + Prisma
- Shared: packages/shared (—Ç–∏–ø—ã, –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã, –¥–∞–Ω–Ω—ã–µ)
- Deploy: Render (–∞–≤—Ç–æ–¥–µ–ø–ª–æ–π —Å GitHub)

## –î–µ–ø–ª–æ–π –∏ –¥–æ—Å—Ç—É–ø—ã
- **–•–æ—Å—Ç–∏–Ω–≥**: Render.com (–∞–≤—Ç–æ–¥–µ–ø–ª–æ–π –ø—Ä–∏ –ø—É—à–µ –≤ master)
- **–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ù–ï–¢ –¥–æ—Å—Ç—É–ø–∞ –∫**: Render dashboard, –ë–î –Ω–∞–ø—Ä—è–º—É—é
- **–ï—Å—Ç—å –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫**: GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
- **–í–∞–∂–Ω–æ**: Render –ù–ï –¥–µ–ø–ª–æ–∏—Ç –µ—Å–ª–∏ –±–∏–ª–¥ –ø–∞–¥–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∏–ª–¥–∞ –ª–æ–∫–∞–ª—å–Ω–æ**: `cd apps/web && npx next build`
- **–í–µ—Ä—Å–∏—è –≤ –∏–≥—Ä–µ**: –µ—Å–ª–∏ —Å—Ç–∞—Ä–∞—è ‚Äî –∑–Ω–∞—á–∏—Ç –±–∏–ª–¥ —É–ø–∞–ª –∏–ª–∏ Render –Ω–µ –∑–∞–¥–µ–ø–ª–æ–∏–ª

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
```
apps/web/
  server.js              # Socket.io backend (single file, ~4000 —Å—Ç—Ä–æ–∫)
  prisma/schema.prisma   # Database schema
  src/components/        # React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
    game/PhaserGame.tsx  # –ì–ª–∞–≤–Ω—ã–π –∏–≥—Ä–æ–≤–æ–π UI
    tabs/                # CharacterTab, TreasuryTab, LeaderboardTab, ShopTab
  src/game/              # Phaser (config + scenes)
  services/              # StatsService.js

packages/shared/src/
  data/items.ts          # –ë–∞–∑–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ (ITEMS)
  data/sets.ts           # –°–µ—Ç–æ–≤—ã–µ –±–æ–Ω—É—Å—ã (SETS)
  data/lootTables.ts     # –¢–∞–±–ª–∏—Ü—ã –¥—Ä–æ–ø–∞ —Å—É–Ω–¥—É–∫–æ–≤ (CHESTS)
  types/                 # –û–±—â–∏–µ —Ç–∏–ø—ã
```

## –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã –¥–∞–Ω–Ω—ã—Ö (–ù–ï –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–∏–≤–∞—Ç—å —Ü–∏—Ñ—Ä—ã!)
| –§–∞–π–ª | –ß—Ç–æ —Å–æ–¥–µ—Ä–∂–∏—Ç |
|------|--------------|
| `data/items.ts` | –í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã: id, slot, rarity, stats, setId |
| `data/sets.ts` | –°–µ—Ç—ã –∏ –±–æ–Ω—É—Å—ã (3/7, 6/7) |
| `data/lootTables.ts` | CHESTS, CHEST_UI, RARITY_STYLES |

## –ë–∞–ª–∞–Ω—Å —Å—Ç–∞—Ä—Ç–∞ (MVP)
```
–ë–∞–∑–æ–≤—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã: –°–ò–õ=10, –õ–û–í=10, –°–¢–û–ô=12, –ò–ù–¢=10, –î–£–•=10

P.Atk = 10 + (–°–ò–õ-10)*1 + equipment
P.Def = 0 + equipment
MaxStamina = 800 + (–°–¢–û–ô-10)*80  = 960 –ø—Ä–∏ –°–¢–û–ô=12
MaxMana = 400 + (–î–£–•-10)*40

–°–µ—Ç –Ω–æ–≤–∏—á–∫–∞ (7 –ø—Ä–µ–¥–º–µ—Ç–æ–≤):
- Weapon: +8 pAtk
- Helmet/Gloves/Legs/Boots/Shield: +1-3 pDef each
- 3/7 –±–æ–Ω—É—Å: +3% P.Atk
- 6/7 –±–æ–Ω—É—Å: +5% P.Atk, +5% P.Def
```

## –ù–∞–≥—Ä–∞–¥—ã –∑–∞ –±–æ—Å—Å–∞ (TZ –≠—Ç–∞–ø 2)
```
–í—Å–µ eligible (30+ —Å–µ–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏): 2 Wooden –±–∞–∑–æ–≤–æ

Rank 1:     +1 Gold, +2 Silver, +2 Bronze, badge "Slayer" (7 –¥–Ω–µ–π)
Rank 2:     +1 Gold, +1 Silver, +2 Bronze, badge "Elite" (7 –¥–Ω–µ–π)
Rank 3:     +1 Gold, +1 Silver, +1 Bronze, badge "Elite" (3 –¥–Ω—è)
Rank 4-10:  +1 Silver, +1 Bronze
Rank 11-25: +1 Silver
Rank 26-50: +1 Bronze, +1 Wooden
Rank 51-100: +1 Bronze
Rank 101+:  —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ 2 Wooden

–ù–µ eligible (<30 —Å–µ–∫): –Ω–∏—á–µ–≥–æ
```

## Consumables
| Item | –≠—Ñ—Ñ–µ–∫—Ç | –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å |
|------|--------|--------------|
| Soulshot NG | x2 —É—Ä–æ–Ω–∞ | 1 —Ç–∞–ø |
| Soulshot D | x2.2 —É—Ä–æ–Ω–∞ | 1 —Ç–∞–ø |
| Soulshot C | x3.5 —É—Ä–æ–Ω–∞ | 1 —Ç–∞–ø |
| Scroll Haste | +30% —Å–∫–æ—Ä–æ—Å—Ç—å –∞—Ç–∞–∫–∏ | 30 —Å–µ–∫ |
| Scroll Acumen | +50% —É—Ä–æ–Ω–∞ | 30 —Å–µ–∫ |
| Scroll Luck | +10% –∫—Ä–∏—Ç —à–∞–Ω—Å | 60 —Å–µ–∫ |

## –°—É–Ω–¥—É–∫–∏
| –¢–∏–ø | –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | –õ—É—Ç |
|-----|--------------|-----|
| Wooden | 5 –º–∏–Ω | 1000 gold, 55% —à–º–æ—Ç, 3% —Å–≤–∏—Ç–æ–∫ |
| Bronze | 30 –º–∏–Ω | 2500 gold, 80% —à–º–æ—Ç, 15% —Å–≤–∏—Ç–æ–∫ |
| Silver | 4 —á–∞—Å–∞ | 7000 gold, 100% —à–º–æ—Ç, 25% —Å–≤–∏—Ç–æ–∫ |
| Gold | 8 —á–∞—Å–æ–≤ | 20000 gold, 100% —à–º–æ—Ç, 45% —Å–≤–∏—Ç–æ–∫ |

## Server Features
- **Graceful shutdown**: SIGTERM/SIGINT —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç boss state + –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–æ–≤
- **onlineUsers cleanup**: –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω —É–¥–∞–ª—è–µ—Ç stale (>30 –º–∏–Ω –±–µ–∑ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)
- **Boss state persistence**: —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫
- **Previous boss session**: —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞

## –í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞
1. **–í—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–π –≤–µ—Ä—Å–∏—é –ø—Ä–∏ –∫–æ–º–º–∏—Ç–µ**
2. **–¶–∏—Ñ—Ä—ã –±–∞–ª–∞–Ω—Å–∞ ‚Äî —Ç–æ–ª—å–∫–æ –∏–∑ —Ñ–∞–π–ª–æ–≤ data/**
3. **–ù–µ —Å–æ–∑–¥–∞–≤–∞–π –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏**
4. **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º –≤ data/ —Ñ–∞–π–ª–∞—Ö**
5. **ITEMS —Ç–∞–±–ª–∏—Ü—É (data/items.ts) –∏–∑–º–µ–Ω—è—Ç—å –¢–û–õ–¨–ö–û —Å –ø–∏—Å—å–º–µ–Ω–Ω–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è!**
6. **server.js —Å–æ–¥–µ—Ä–∂–∏—Ç TODO-–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å shared**

## SSOT: –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã (–ö–†–ò–¢–ò–ß–ù–û!)
**–ë–î ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è –≤—Å–µ—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ –∏–≥—Ä–æ–∫–∞.**

### –†–µ—Å—É—Ä—Å—ã –ø–æ–¥ SSOT:
- `gold` ‚Äî –∑–æ–ª–æ—Ç–æ
- `ancientCoin` ‚Äî –∫—Ä–∏—Å—Ç–∞–ª–ª—ã (üíé)
- `lotteryTickets` ‚Äî –±–∏–ª–µ—Ç—ã (üéüÔ∏è)
- `ether`, `etherDust` ‚Äî —ç—Ñ–∏—Ä –∏ –ø—ã–ª—å
- `enchantCharges`, `protectionCharges` ‚Äî –∑–∞—Ä—è–¥—ã –∑–∞—Ç–æ—á–∫–∏/–∑–∞—â–∏—Ç—ã
- `potionHaste`, `potionAcumen`, `potionLuck` ‚Äî –∑–µ–ª—å—è
- `keyWooden`, `keyBronze`, `keySilver`, `keyGold` ‚Äî –∫–ª—é—á–∏
- `exp`, `sp` ‚Äî –æ–ø—ã—Ç –∏ –æ—á–∫–∏ –Ω–∞–≤—ã–∫–æ–≤
- `totalDamage`, `totalClicks` ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã —Å —Ä–µ—Å—É—Ä—Å–∞–º–∏:
```javascript
// ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û ‚Äî SET —á–µ—Ä–µ–∑ player.* –≤ –ø–∞–º—è—Ç—å
player.gold -= cost;
await prisma.user.update({ data: { gold: BigInt(player.gold) } });

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û ‚Äî increment/decrement –Ω–∞–ø—Ä—è–º—É—é –≤ –ë–î
const updated = await prisma.user.update({
  where: { id: odamage },
  data: { gold: { decrement: BigInt(cost) } },
  select: { gold: true },
});
player.gold = Number(updated.gold); // sync –ø–∞–º—è—Ç—å –ü–û–°–õ–ï –ë–î
```

### –ü—Ä–∏–Ω—Ü–∏–ø—ã:
1. **–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `player.*` –¥–ª—è –ó–ê–ü–ò–°–ò –≤ –ë–î** ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è/–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
2. **–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `increment`/`decrement`** –≤ Prisma –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
3. **–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ update ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–∞–º—è—Ç—å** –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ Prisma
4. **–ü–∞–º—è—Ç—å (`player.*`) –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–µ–π** ‚Äî –¥–æ–≤–µ—Ä—è—Ç—å —Ç–æ–ª—å–∫–æ –ë–î

## –ü—Ä–∞–≤–∏–ª–∞ —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏ (–ö–†–ò–¢–ò–ß–ù–û!)
1. **–ù–ò–ö–û–ì–î–ê –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å generic –ø—Ä–µ–¥–º–µ—Ç—ã!** –î—Ä–æ–ø —Ç–æ–ª—å–∫–æ –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –≤ –ë–î —Å `droppable=true`
2. **–ö–∞–∂–¥—ã–π –ø—Ä–µ–¥–º–µ—Ç ‚Äî –≤ 4 —Ä–µ–¥–∫–æ—Å—Ç—è—Ö** (common, uncommon, rare, epic)
3. **–í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç —Å–µ—Ç—É** (setId –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω)
4. **–°–µ—Ç—ã –∏–º–µ–Ω—É—é—Ç—Å—è –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏**: novice ‚Üí iron ‚Üí steel ‚Üí mithril –∏ —Ç.–¥.
5. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–º—ë–Ω**: `{set}-{slot}` (–Ω–∞–ø—Ä–∏–º–µ—Ä: `iron-sword`, `steel-helmet`)
6. **–î—Ä–æ–ø**: –µ—Å–ª–∏ –Ω–µ—Ç droppable –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –Ω—É–∂–Ω–æ–π —Ä–µ–¥–∫–æ—Å—Ç–∏ ‚Äî –≤—ã–¥–∞—ë—Ç—Å—è –±–æ–Ω—É—Å gold
7. **–£–ª—É—á—à–µ–Ω–∏–µ —Ä–µ–¥–∫–æ—Å—Ç–∏**: –ù–ï —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ, –ø—Ä–µ–¥–º–µ—Ç—ã –¥—Ä–æ–ø–∞—é—Ç—Å—è –≥–æ—Ç–æ–≤–æ–π —Ä–µ–¥–∫–æ—Å—Ç–∏

## –ë–∞–ª–∞–Ω—Å —Å—Ç–∞—Ç–æ–≤ –ø–æ —Ä–µ–¥–∫–æ—Å—Ç–∏
| Rarity | pAtk (weapon) | pDef (armor) | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|---------------|--------------|----------|
| Common | 8-10 | 1-3 | –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∞—Ç—ã |
| Uncommon | 12-14 | 3-5 | +20-40% –∫ —Å—Ç–∞—Ç–∞–º |
| Rare | 16-18 | 5-7 | +60-80% –∫ —Å—Ç–∞—Ç–∞–º |
| Epic | 20-24 | 8-10 | +100-140% –∫ —Å—Ç–∞—Ç–∞–º |

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã (v1.7+)
- **Daily/Weekly Tasks v2.0**: Server SSOT, 5 daily + 6 grind + invite tasks
- **Activity Points (AP)**: 0-160 AP/–¥–µ–Ω—å, –º–∏–ª–µ—Å—Ç–æ–Ω—ã 30/60/100 —Å –Ω–∞–≥—Ä–∞–¥–∞–º–∏
- **14-Day Check-In**: Streak –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–º–∏ –Ω–∞–≥—Ä–∞–¥–∞–º–∏

## Enchant System v1.2 (—Ç–µ–∫—É—â–∞—è)
- EnchantCharges: –∏–∑ —Å—É–Ω–¥—É–∫–æ–≤ (Wooden:1-2, Bronze:2-4, Silver:4-8, Gold:8-15)
- Protection: 5% —à–∞–Ω—Å –∏–∑ Gold —Å—É–Ω–¥—É–∫–æ–≤ + –ø–æ–∫—É–ø–∫–∞ –∑–∞ 50üíé
- Broken items: 8 —á–∞—Å–æ–≤ —Ç–∞–π–º–µ—Ä, –ø–æ—Ç–æ–º –∞–≤—Ç–æ-—É–¥–∞–ª–µ–Ω–∏–µ
- Restore: —Å—Ç–æ–∏–º–æ—Å—Ç—å = BaseByRarity * (1 + enchantLevel * 0.25)
- Base costs: common=10üíé, uncommon=25üíé, rare=60üíé, epic=120üíé
