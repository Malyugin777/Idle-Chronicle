generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// USERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model User {
  id              String   @id @default(cuid())

  // Telegram
  telegramId      BigInt   @unique
  username        String?
  firstName       String?
  photoUrl        String?
  language        String   @default("en")  // ru, en

  // Stats (L2-style)
  level           Int      @default(1)
  exp             BigInt   @default(0)

  // Base Stats (legacy - for backward compatibility)
  str             Int      @default(1)
  dex             Int      @default(1)
  luck            Int      @default(1)

  // L2 Core Attributes (NEW)
  power           Int      @default(10)    // â†’ Physical Power (P.Atk)
  agility         Int      @default(10)    // â†’ Attack Speed, Crit Chance
  vitality        Int      @default(10)    // â†’ Max Health, Max Stamina
  intellect       Int      @default(10)    // â†’ Magic Power (future)
  spirit          Int      @default(10)    // â†’ Max Mana (future)

  // Derived Stats (legacy)
  pAtk            Int      @default(10)
  critChance      Float    @default(0.05)
  critDamage      Float    @default(2.0)
  attackSpeed     Float    @default(1.0)

  // L2 Derived Stats (NEW - cached from calculateDerived)
  physicalPower   Int      @default(15)    // floor(basePower * powerMod)
  maxHealth       Int      @default(100)   // floor(baseHealth * vitalityMod)
  physicalDefense Int      @default(40)    // P.Def for thorns reduction

  // Stamina System (NEW - replaces Mana for combat)
  stamina         Int      @default(100)   // Current stamina
  maxStamina      Int      @default(100)   // max(100, floor(maxHealth * 10))
  lastStaminaTick DateTime @default(now())
  exhaustedUntil  DateTime?               // null = not exhausted

  // Mana System (kept for skills/magic - future use)
  mana            Int      @default(1000)
  maxMana         Int      @default(1000)
  manaRegen       Float    @default(0.2)  // 1 per 5 seconds = 0.2/sec, upgradeable to 10/sec
  lastManaTick    DateTime @default(now())

  // Tap & Auto-Attack System
  tapsPerSecond   Int      @default(3)    // Base 3 TPS, max 10
  autoAttackSpeed Int      @default(0)    // Auto attacks per second, max 10

  // First time player flag
  isFirstLogin    Boolean  @default(true)

  // Currencies
  adena           BigInt   @default(0)
  ancientCoin     Int      @default(0)
  tonBalance      Float    @default(0)    // TON cryptocurrency balance

  // Consumables
  soulshotNG      Int      @default(100)
  soulshotD       Int      @default(0)
  soulshotC       Int      @default(0)

  potionHaste     Int      @default(0)
  potionAcumen    Int      @default(0)
  potionLuck      Int      @default(0)

  activeSoulshot  String?

  // Equipment
  weaponId        String?
  weapon          Weapon?  @relation(fields: [weaponId], references: [id])
  weaponEnchant   Int      @default(0)

  // Progression
  totalDamage     BigInt   @default(0)
  totalClicks     BigInt   @default(0)
  bossesKilled    Int      @default(0)
  highestDps      Int      @default(0)

  // Offline
  lastOnline      DateTime @default(now())
  offlineEarnings BigInt   @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  inventory       InventoryItem[]
  damageLog       DamageLog[]
  buffs           ActiveBuff[]
  tasks           UserTask[]
  chests          Chest[]

  @@index([telegramId])
  @@index([totalDamage])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEAPONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model Weapon {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  grade       Grade    @default(NG)

  pAtk        Int
  critBonus   Float    @default(0)

  cost        BigInt
  requiredLvl Int      @default(1)

  iconUrl     String?

  users       User[]
}

enum Grade {
  NG
  D
  C
  B
  A
  S
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIVE BUFFS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model ActiveBuff {
  id        String   @id @default(cuid())
  userId    String

  buffType  BuffType
  value     Float
  expiresAt DateTime

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

enum BuffType {
  HASTE
  ACUMEN
  LUCK
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHESTS (LOOT BOXES)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model Chest {
  id              String      @id @default(cuid())
  userId          String
  rarity          ChestRarity @default(COMMON)

  openingStarted  DateTime?   // null = not opening, set = timer started
  openingDuration Int         // Duration in ms to open

  fromBossId      String?     // Which boss dropped this chest
  fromSessionId   String?     // Which session

  createdAt       DateTime    @default(now())

  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum ChestRarity {
  COMMON      // 5 min
  UNCOMMON    // 30 min
  RARE        // 4 hours
  EPIC        // 8 hours
  LEGENDARY   // 24 hours
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ITEMS & INVENTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model Item {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String?

  type        ItemType
  rarity      Rarity   @default(COMMON)
  grade       Grade    @default(NG)

  isRpgItem   Boolean  @default(true)
  rpgValue    Int?

  iconUrl     String?

  inventory   InventoryItem[]
  lootTables  BossLoot[]
}

model InventoryItem {
  id        String   @id @default(cuid())
  userId    String
  itemId    String
  quantity  Int      @default(1)

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  item      Item     @relation(fields: [itemId], references: [id])

  @@unique([userId, itemId])
}

enum ItemType {
  SCROLL
  MATERIAL
  RECIPE
  ARMOR_PART
  CURRENCY
}

enum Rarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WORLD BOSS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model Boss {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  title       String?

  baseHp      BigInt
  defense     Int      @default(0)
  thornsDamage Int     @default(0)   // ĞĞ±Ñ€Ğ°Ñ‚ĞºĞ° Ğ±Ğ¾ÑÑĞ° - Ñ‚Ñ€Ğ°Ñ‚Ğ¸Ñ‚ stamina Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°

  ragePhases  Json

  spineJson   String?
  spineAtlas  String?
  iconUrl     String?

  isActive    Boolean  @default(false)
  order       Int      @default(0)

  timesKilled Int      @default(0)

  lootTable   BossLoot[]
  sessions    BossSession[]
}

model BossLoot {
  id        String   @id @default(cuid())
  bossId    String
  itemId    String

  dropChance Float
  minQty     Int     @default(1)
  maxQty     Int     @default(1)

  minDamagePercent Float?

  boss      Boss     @relation(fields: [bossId], references: [id])
  item      Item     @relation(fields: [itemId], references: [id])
}

model BossSession {
  id          String   @id @default(cuid())
  bossId      String
  bossName    String?    // Cached boss name

  startedAt   DateTime @default(now())
  endedAt     DateTime?

  maxHp       BigInt
  totalDamage BigInt   @default(0)

  // Winners
  finalBlowBy     String?
  finalBlowName   String?
  finalBlowDamage BigInt?

  topDamageBy     String?
  topDamageName   String?
  topDamage       BigInt?

  // Prize pool
  tonPool         Float    @default(0)
  chestsPool      Int      @default(0)
  expPool         BigInt   @default(0)

  // Leaderboard snapshot (JSON array of top 20)
  leaderboardSnapshot Json?

  boss        Boss     @relation(fields: [bossId], references: [id])
  damageLog   DamageLog[]

  @@index([bossId])
  @@index([endedAt])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DAMAGE LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model DamageLog {
  id        String   @id @default(cuid())

  sessionId String
  odamage   String

  damage    BigInt
  clicks    Int
  crits     Int

  // Cached for leaderboard display
  playerName  String?
  playerPhoto String?
  damagePercent Float?   // % of total boss damage

  timestamp DateTime @default(now())

  session   BossSession @relation(fields: [sessionId], references: [id])
  user      User        @relation(fields: [odamage], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([odamage])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TASKS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model Task {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String

  type        TaskType
  target      Int

  adenaReward      BigInt @default(0)
  ancientCoinReward Int   @default(0)

  users       UserTask[]
}

model UserTask {
  id        String   @id @default(cuid())
  odamage    String
  taskId    String

  progress  Int      @default(0)
  completed Boolean  @default(false)
  claimedAt DateTime?

  resetAt   DateTime @default(now())

  user      User     @relation(fields: [odamage], references: [id], onDelete: Cascade)
  task      Task     @relation(fields: [taskId], references: [id])

  @@unique([odamage, taskId])
}

enum TaskType {
  DAILY
  WEEKLY
  ACHIEVEMENT
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME STATE (Persistent server state across restarts)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model GameState {
  id              String   @id @default("singleton")  // Always "singleton"

  // Current boss state
  currentBossIndex Int     @default(0)
  bossCurrentHp    BigInt  @default(500000)
  bossMaxHp        BigInt  @default(500000)
  bossName         String  @default("Lizard")
  bossIcon         String  @default("ğŸ¦")
  bossDefense      Int     @default(0)
  bossThorns       Int     @default(0)

  // Boss rewards
  bossAdenaReward  Int     @default(1000)
  bossExpReward    BigInt  @default(1000000)
  bossTonReward    Float   @default(10)
  bossChestsReward Int     @default(10)

  // Respawn timer (null = boss alive, timestamp = respawning)
  respawnAt        DateTime?

  // Session leaderboard (JSON - resets on boss kill)
  sessionLeaderboard Json?

  updatedAt        DateTime @updatedAt
}
