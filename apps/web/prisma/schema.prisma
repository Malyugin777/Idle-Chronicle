generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// USERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model User {
  id              String   @id @default(cuid())

  // Telegram
  telegramId      BigInt   @unique
  username        String?
  firstName       String?
  photoUrl        String?
  language        String   @default("en")  // ru, en

  // Stats (L2-style)
  level           Int      @default(1)
  exp             BigInt   @default(0)

  // Base Stats (legacy - for backward compatibility)
  str             Int      @default(1)
  dex             Int      @default(1)
  luck            Int      @default(1)

  // L2 Core Attributes (MVP)
  power           Int      @default(10)    // Ğ¡Ğ˜Ğ› â†’ Physical Power (P.Atk)
  agility         Int      @default(10)    // Ğ›ĞĞ’ â†’ Attack Speed, Crit Chance
  vitality        Int      @default(12)    // Ğ¡Ğ¢ĞĞ™ â†’ Max Stamina (12 Ğ´Ğ»Ñ "Ğ´Ğ»Ğ¸Ğ½Ğ½Ğ¾Ğ¹ ÑĞµÑÑĞ¸Ğ¸")
  intellect       Int      @default(10)    // Ğ˜ĞĞ¢ â†’ Skill Power
  spirit          Int      @default(10)    // Ğ”Ğ£Ğ¥ â†’ Max Mana, Mana Regen

  // Derived Stats (legacy)
  pAtk            Int      @default(10)
  critChance      Float    @default(0.05)
  critDamage      Float    @default(2.0)
  attackSpeed     Float    @default(1.0)

  // L2 Derived Stats (MVP Ñ„Ğ¾Ñ€Ğ¼ÑƒĞ»Ñ‹)
  physicalPower   Int      @default(10)    // P.Atk = 10 (Ğ±Ğ°Ğ·Ğ° ĞºÑƒĞ»Ğ°ĞºĞ°Ğ¼Ğ¸)
  maxHealth       Int      @default(140)   // 100 + (12-10)*20 = 140
  physicalDefense Int      @default(0)     // P.Def = 0 (Ğ³Ğ¾Ğ»Ñ‹Ğ¹)

  // Stamina System (Ğ¡Ğ¢ĞĞ™ Ğ²Ğ»Ğ¸ÑĞµÑ‚ Ğ½Ğ° Ğ´Ğ»Ğ¸Ğ½Ñƒ ÑĞµÑÑĞ¸Ğ¸)
  stamina         Int      @default(960)   // 800 + (12-10)*80 = 960
  maxStamina      Int      @default(960)   // MaxStamina = 800 + (Ğ¡Ğ¢ĞĞ™-10)*80
  lastStaminaTick DateTime @default(now())
  exhaustedUntil  DateTime?               // null = not exhausted, 5 ÑĞµĞº Ğ¿Ñ€Ğ¸ 0

  // Mana System (Ğ”Ğ£Ğ¥ Ğ²Ğ»Ğ¸ÑĞµÑ‚ Ğ½Ğ° Ğ¼Ğ°Ğ½Ñƒ)
  mana            Int      @default(100)   // MP max = 100 + (Ğ”Ğ£Ğ¥-10)*10
  maxMana         Int      @default(100)
  manaRegen       Float    @default(1.0)   // 1 MP per second
  lastManaTick    DateTime @default(now())

  // Tap & Auto-Attack System
  tapsPerSecond   Int      @default(3)    // Base 3 TPS, max 10
  autoAttackSpeed Int      @default(0)    // Auto attacks per second, max 10

  // First time player flag
  isFirstLogin    Boolean  @default(true)

  // Currencies
  gold            BigInt   @default(0)
  ancientCoin     Int      @default(0)
  tonBalance      Float    @default(0)    // TON cryptocurrency balance

  // Chest Slots System
  chestSlots      Int      @default(5)    // Unlocked chest slots (5-10), buy more for 999 crystals
  totalGoldEarned BigInt   @default(0)    // Total gold earned all-time

  // Total chests opened by TYPE
  totalChestsWooden   Int  @default(0)
  totalChestsBronze   Int  @default(0)
  totalChestsSilver   Int  @default(0)
  totalChestsGold     Int  @default(0)

  // Pity system: count silver+gold chests without Epic drop
  // Resets to 0 when Epic drops
  pityCounter         Int  @default(0)

  // Enchant scrolls
  enchantScrolls  Int      @default(0)    // Ğ¡Ğ²Ğ¸Ñ‚ĞºĞ¸ Ğ·Ğ°Ñ‚Ğ¾Ñ‡ĞºĞ¸

  // Ether System (Ğ­Ñ„Ğ¸Ñ€Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ»)
  ether           Int      @default(100)
  etherDust       Int      @default(0)     // ĞĞ°ĞºĞ°Ğ¿Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¾Ñ„Ñ„Ğ»Ğ°Ğ¹Ğ½ (10/Ğ¼Ğ¸Ğ½, Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ 4800)
  autoEther       Boolean  @default(false)
  autoAttack      Boolean  @default(false) // AUTO toggle

  // Potions/Scrolls
  potionHaste     Int      @default(0)
  potionAcumen    Int      @default(0)
  potionLuck      Int      @default(0)

  // Equipment (legacy weapon)
  weaponId        String?
  weapon          Weapon?  @relation(fields: [weaponId], references: [id])
  weaponEnchant   Int      @default(0)

  // Progression
  totalDamage     BigInt   @default(0)
  totalClicks     BigInt   @default(0)
  bossesKilled    Int      @default(0)
  highestDps      Int      @default(0)

  // Offline
  lastOnline      DateTime @default(now())
  offlineEarnings BigInt   @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  inventory       InventoryItem[]
  equipment       UserEquipment[]
  damageLog       DamageLog[]
  buffs           ActiveBuff[]
  tasks           UserTask[]
  chests          Chest[]
  pendingRewards  PendingReward[]
  badges          UserBadge[]

  @@index([telegramId])
  @@index([totalDamage])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PENDING REWARDS (Boss kill rewards waiting to be claimed)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model PendingReward {
  id            String   @id @default(cuid())
  userId        String

  bossSessionId String   // Which boss kill this is for
  bossName      String   // Cached boss name for display
  bossIcon      String   @default("ğŸ‘¹")

  // Reward breakdown
  rank          Int?     // Player's rank (1-100+), null if not in top
  wasEligible   Boolean  @default(true) // Had 30sec activity

  // Chest rewards
  chestsWooden  Int      @default(0)
  chestsBronze  Int      @default(0)
  chestsSilver  Int      @default(0)
  chestsGold    Int      @default(0)

  // Crystal bonus (Gold +10, Silver +5)
  crystals      Int      @default(0)

  // Badge reward (if top-3)
  badgeId       String?  // "slayer" or "elite"
  badgeDuration Int?     // Duration in days (7 or 3)

  claimed       Boolean  @default(false)
  claimedAt     DateTime?

  createdAt     DateTime @default(now())

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([bossSessionId])
  @@unique([userId, bossSessionId]) // One reward per boss per user
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// USER BADGES (Cosmetic badges with expiration)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model UserBadge {
  id        String   @id @default(cuid())
  userId    String

  badgeId   String   // "slayer", "elite", etc.
  name      String   // Display name
  icon      String   // Emoji or icon

  expiresAt DateTime

  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EQUIPMENT SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model Equipment {
  id          String        @id @default(cuid())
  code        String        @unique
  name        String
  nameRu      String        @default("")
  icon        String        @default("ğŸ—¡ï¸")

  slot        EquipmentSlot
  rarity      ItemRarity    @default(COMMON)

  // Base stats (varies by rarity)
  pAtkMin     Int           @default(0)
  pAtkMax     Int           @default(0)
  pDefMin     Int           @default(0)
  pDefMax     Int           @default(0)

  // Can drop from chests
  droppable   Boolean       @default(true)

  userEquipment UserEquipment[]
}

model UserEquipment {
  id          String        @id @default(cuid())
  userId      String
  equipmentId String

  // Rolled stats (fixed when obtained)
  pAtk        Int           @default(0)
  pDef        Int           @default(0)

  // Enchant level (+1, +2, etc.)
  enchant     Int           @default(0)

  // Is currently equipped?
  isEquipped  Boolean       @default(false)

  createdAt   DateTime      @default(now())

  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  equipment   Equipment     @relation(fields: [equipmentId], references: [id])

  @@index([userId])
  @@index([equipmentId])
}

enum EquipmentSlot {
  WEAPON      // ĞÑ€ÑƒĞ¶Ğ¸Ğµ
  HELMET      // Ğ¨Ğ»ĞµĞ¼
  CHEST       // ĞĞ°Ğ³Ñ€ÑƒĞ´Ğ½Ğ¸Ğº
  GLOVES      // ĞŸĞµÑ€Ñ‡Ğ°Ñ‚ĞºĞ¸
  LEGS        // ĞŸĞ¾Ğ½Ğ¾Ğ¶Ğ¸
  BOOTS       // Ğ‘Ğ¾Ñ‚Ğ¸Ğ½ĞºĞ¸
  SHIELD      // Ğ©Ğ¸Ñ‚
}

enum ItemRarity {
  COMMON      // Ğ‘ĞµĞ»Ñ‹Ğ¹, Ğ±ĞµĞ· glow
  UNCOMMON    // Ğ—ĞµĞ»ĞµĞ½Ñ‹Ğ¹, Ñ glow
  RARE        // Ğ¤Ğ¸Ğ¾Ğ»ĞµÑ‚Ğ¾Ğ²Ñ‹Ğ¹, Ñ glow
  EPIC        // ĞÑ€Ğ°Ğ½Ğ¶ĞµĞ²Ñ‹Ğ¹, Ñ glow
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEAPONS (legacy - keep for compatibility)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model Weapon {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  grade       Grade    @default(NG)

  pAtk        Int
  critBonus   Float    @default(0)

  cost        BigInt
  requiredLvl Int      @default(1)

  iconUrl     String?

  users       User[]
}

enum Grade {
  NG
  D
  C
  B
  A
  S
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIVE BUFFS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model ActiveBuff {
  id        String   @id @default(cuid())
  userId    String

  buffType  BuffType
  value     Float
  expiresAt DateTime

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

enum BuffType {
  HASTE
  ACUMEN
  LUCK
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHESTS (LOOT BOXES)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model Chest {
  id              String    @id @default(cuid())
  userId          String
  chestType       ChestType @default(WOODEN)

  openingStarted  DateTime?   // null = not opening, set = timer started
  openingDuration Int         // Duration in ms to open

  fromBossId      String?     // Which boss dropped this chest
  fromSessionId   String?     // Which session

  createdAt       DateTime    @default(now())

  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum ChestType {
  WOODEN      // ğŸªµ Ğ”ĞµÑ€ĞµĞ²ÑĞ½Ğ½Ñ‹Ğ¹ - 5 min
  BRONZE      // ğŸŸ« Ğ‘Ñ€Ğ¾Ğ½Ğ·Ğ¾Ğ²Ñ‹Ğ¹ - 30 min
  SILVER      // ğŸª™ Ğ¡ĞµÑ€ĞµĞ±Ñ€ÑĞ½Ñ‹Ğ¹ - 4 hours
  GOLD        // ğŸŸ¨ Ğ—Ğ¾Ğ»Ğ¾Ñ‚Ğ¾Ğ¹ - 8 hours
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ITEMS & INVENTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model Item {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String?

  type        ItemType
  rarity      Rarity   @default(COMMON)
  grade       Grade    @default(NG)

  isRpgItem   Boolean  @default(true)
  rpgValue    Int?

  iconUrl     String?

  inventory   InventoryItem[]
  lootTables  BossLoot[]
}

model InventoryItem {
  id        String   @id @default(cuid())
  userId    String
  itemId    String
  quantity  Int      @default(1)

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  item      Item     @relation(fields: [itemId], references: [id])

  @@unique([userId, itemId])
}

enum ItemType {
  SCROLL
  MATERIAL
  RECIPE
  ARMOR_PART
  CURRENCY
}

enum Rarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WORLD BOSS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model Boss {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  title       String?

  baseHp      BigInt
  defense     Int      @default(0)
  thornsDamage Int     @default(0)   // ĞĞ±Ñ€Ğ°Ñ‚ĞºĞ° Ğ±Ğ¾ÑÑĞ° - Ñ‚Ñ€Ğ°Ñ‚Ğ¸Ñ‚ stamina Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°

  ragePhases  Json

  spineJson   String?
  spineAtlas  String?
  iconUrl     String?

  isActive    Boolean  @default(false)
  order       Int      @default(0)

  timesKilled Int      @default(0)

  lootTable   BossLoot[]
  sessions    BossSession[]
}

model BossLoot {
  id        String   @id @default(cuid())
  bossId    String
  itemId    String

  dropChance Float
  minQty     Int     @default(1)
  maxQty     Int     @default(1)

  minDamagePercent Float?

  boss      Boss     @relation(fields: [bossId], references: [id])
  item      Item     @relation(fields: [itemId], references: [id])
}

model BossSession {
  id          String   @id @default(cuid())
  bossId      String
  bossName    String?    // Cached boss name

  startedAt   DateTime @default(now())
  endedAt     DateTime?

  maxHp       BigInt
  totalDamage BigInt   @default(0)

  // Winners
  finalBlowBy     String?
  finalBlowName   String?
  finalBlowDamage BigInt?

  topDamageBy     String?
  topDamageName   String?
  topDamage       BigInt?

  // Prize pool
  tonPool         Float    @default(0)
  chestsPool      Int      @default(0)
  expPool         BigInt   @default(0)

  // Leaderboard snapshot (JSON array of top 20)
  leaderboardSnapshot Json?

  boss        Boss     @relation(fields: [bossId], references: [id])
  damageLog   DamageLog[]

  @@index([bossId])
  @@index([endedAt])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DAMAGE LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model DamageLog {
  id        String   @id @default(cuid())

  sessionId String
  odamage   String

  damage    BigInt
  clicks    Int
  crits     Int

  // Cached for leaderboard display
  playerName  String?
  playerPhoto String?
  damagePercent Float?   // % of total boss damage

  timestamp DateTime @default(now())

  session   BossSession @relation(fields: [sessionId], references: [id])
  user      User        @relation(fields: [odamage], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([odamage])
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TASKS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model Task {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String

  type        TaskType
  target      Int

  goldReward       BigInt @default(0)
  ancientCoinReward Int   @default(0)

  users       UserTask[]
}

model UserTask {
  id        String   @id @default(cuid())
  odamage    String
  taskId    String

  progress  Int      @default(0)
  completed Boolean  @default(false)
  claimedAt DateTime?

  resetAt   DateTime @default(now())

  user      User     @relation(fields: [odamage], references: [id], onDelete: Cascade)
  task      Task     @relation(fields: [taskId], references: [id])

  @@unique([odamage, taskId])
}

enum TaskType {
  DAILY
  WEEKLY
  ACHIEVEMENT
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME STATE (Persistent server state across restarts)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model GameState {
  id              String   @id @default("singleton")  // Always "singleton"

  // Current boss state
  currentBossIndex Int     @default(0)
  bossCurrentHp    BigInt  @default(500000)
  bossMaxHp        BigInt  @default(500000)
  bossName         String  @default("Serpent")
  bossNameRu       String  @default("Ğ—Ğ¼ĞµĞ¹")
  bossIcon         String  @default("ğŸ")
  bossDefense      Int     @default(0)
  bossThorns       Int     @default(0)

  // Boss rewards
  bossGoldReward   Int     @default(1000000)
  bossExpReward    BigInt  @default(1000000)
  bossTonReward    Float   @default(10)
  bossChestsReward Int     @default(10)

  // Respawn timer (null = boss alive, timestamp = respawning)
  respawnAt        DateTime?

  // Session leaderboard (JSON - resets on boss kill)
  sessionLeaderboard Json?

  // Previous boss session (for leaderboard tab)
  previousBossSession Json?

  updatedAt        DateTime @updatedAt
}
