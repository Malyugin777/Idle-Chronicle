================================================================================
ЗАДАЧА: РЕАЛИЗОВАТЬ ОФФЛАЙН ФАРМ СИСТЕМУ
================================================================================

КОНТЕКСТ:
Idle Chronicle - мобильный кликер-RPG для Telegram Mini App.
Игрок бьёт боссов, получает лут, качается.
Нужно добавить систему оффлайн фарминга - пока игрок offline, персонаж продолжает фармить.

================================================================================
КЛЮЧЕВЫЕ ПОЛЯ В БД (prisma/schema.prisma)
================================================================================

Существующие поля в модели User:

  // Stamina
  stamina         Int       @default(800)
  maxStamina      Int       @default(960)

  // Combat stats
  pAtk            Int       @default(10)
  physicalDefense Int       @default(0)
  attackSpeed     Int       @default(300)
  critChance      Float     @default(0.05)

  // Character stats
  power           Int       @default(10)
  vitality        Int       @default(12)

НУЖНО ДОБАВИТЬ в модель User:

  // Offline farming
  lastOnline      DateTime?    // Время последнего выхода
  offlineRewards  Json?        // Накопленные оффлайн награды (или отдельная таблица)

================================================================================
ЛОГИКА КОТОРУЮ НУЖНО РЕАЛИЗОВАТЬ
================================================================================

1. ПРИ DISCONNECT:
   - Сохранить lastOnline = текущий timestamp
   - Сохранить текущие статы игрока (pAtk, attackSpeed, critChance)

2. ПРИ CONNECT (auth:success):
   - Загрузить lastOnline из БД
   - Рассчитать offlineTime = now - lastOnline
   - Применить лимит: maxOfflineTime = 8 часов (configurable)
   - Рассчитать награды по формуле
   - Показать игроку модалку "Пока вас не было..."

3. ФОРМУЛА РАСЧЁТА НАГРАД:

   offlineTime = Math.min(now - lastOnline, MAX_OFFLINE_TIME)

   // Базовый урон в секунду (DPS)
   baseDPS = pAtk * (1 + critChance * CRIT_MULTIPLIER)

   // С учётом скорости атаки (attackSpeed = ms между атаками)
   attacksPerSecond = 1000 / attackSpeed
   effectiveDPS = baseDPS * attacksPerSecond

   // Общий урон за оффлайн время
   totalOfflineDamage = effectiveDPS * (offlineTime / 1000)

   // Конвертация урона в лут
   // Например: каждые 1000 урона = 1 gold, каждые 10000 = шанс на предмет
   goldEarned = Math.floor(totalOfflineDamage / DAMAGE_PER_GOLD)
   expEarned = Math.floor(totalOfflineDamage / DAMAGE_PER_EXP)

   // Шанс на дроп предметов (опционально)
   itemDrops = calculateDrops(totalOfflineDamage, lootTables)

================================================================================
КОНФИГУРИРУЕМЫЕ ПАРАМЕТРЫ
================================================================================

const OFFLINE_CONFIG = {
  MAX_OFFLINE_TIME_MS: 8 * 60 * 60 * 1000,  // 8 часов максимум
  DAMAGE_PER_GOLD: 100,                      // 100 урона = 1 gold
  DAMAGE_PER_EXP: 50,                        // 50 урона = 1 exp
  CRIT_MULTIPLIER: 2.0,                      // Множитель крита
  EFFICIENCY_MULTIPLIER: 0.5,                // Эффективность оффлайн (50% от онлайн)
  MIN_OFFLINE_TIME_MS: 5 * 60 * 1000,        // Минимум 5 минут чтобы считать
};

================================================================================
ФАЙЛЫ ДЛЯ ИЗУЧЕНИЯ
================================================================================

1. server.js - серверная логика (Socket.io события, auth, disconnect)
2. schema.prisma - схема базы данных
3. PhaserGame.tsx - главный экран битвы (показ модалки при входе)
4. items.ts - предметы для дропа
5. lootTables.ts - таблицы дропа

================================================================================
ПРИМЕР РЕАЛИЗАЦИИ (псевдокод)
================================================================================

// server.js - при disconnect
socket.on('disconnect', async () => {
  if (player.odamage) {
    await prisma.user.update({
      where: { id: player.odamage },
      data: {
        lastOnline: new Date(),
        // Сохранить статы для расчёта
      }
    });
  }
});

// server.js - при auth:success
const calculateOfflineRewards = async (userId) => {
  const user = await prisma.user.findUnique({ where: { id: userId } });

  if (!user.lastOnline) return null;

  const offlineMs = Date.now() - user.lastOnline.getTime();
  if (offlineMs < OFFLINE_CONFIG.MIN_OFFLINE_TIME_MS) return null;

  const cappedOffline = Math.min(offlineMs, OFFLINE_CONFIG.MAX_OFFLINE_TIME_MS);
  const offlineSeconds = cappedOffline / 1000;

  // Расчёт DPS
  const attacksPerSec = 1000 / user.attackSpeed;
  const avgDamage = user.pAtk * (1 + user.critChance * OFFLINE_CONFIG.CRIT_MULTIPLIER);
  const dps = avgDamage * attacksPerSec * OFFLINE_CONFIG.EFFICIENCY_MULTIPLIER;

  const totalDamage = dps * offlineSeconds;

  return {
    offlineTime: cappedOffline,
    totalDamage: Math.floor(totalDamage),
    gold: Math.floor(totalDamage / OFFLINE_CONFIG.DAMAGE_PER_GOLD),
    exp: Math.floor(totalDamage / OFFLINE_CONFIG.DAMAGE_PER_EXP),
  };
};

// Отправить клиенту
socket.emit('offline:rewards', {
  offlineTime: rewards.offlineTime,
  gold: rewards.gold,
  exp: rewards.exp,
  totalDamage: rewards.totalDamage,
});
