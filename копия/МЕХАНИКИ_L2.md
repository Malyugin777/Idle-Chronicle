# L2 Combat Mechanics - Описание механик

## Обзор изменений

Интегрирована боевая система в стиле Lineage 2 с заменой маны на стамину для боя, добавлением механики шипов (обратки) от боссов и системой истощения.

---

## 1. Система атрибутов (L2 Core Attributes)

### Базовые атрибуты персонажа:

| Атрибут | Значение по умолчанию | Влияние |
|---------|----------------------|---------|
| **Power** | 10 | Физическая сила → P.Atk |
| **Agility** | 10 | Скорость атаки, шанс крита |
| **Vitality** | 10 | Макс. здоровье, макс. стамина |
| **Intellect** | 10 | Магическая сила (будущее) |
| **Spirit** | 10 | Макс. мана (будущее) |

### Модификаторы (экспоненциальный рост):
- Power: +3.6% за каждый пункт выше 10
- Agility: +0.9% за каждый пункт
- Vitality: +3.0% за каждый пункт
- Intellect: +2.0% за каждый пункт
- Spirit: +1.0% за каждый пункт

### Производные статы (Derived Stats):
Рассчитываются автоматически на основе атрибутов и уровня:

```
maxHealth = baseHealth * vitalityMod
maxStamina = max(30, floor(maxHealth * 10))
physicalPower = basePhysicalPower * powerMod
attackSpeed = baseAttackSpeed * agilityMod
critChance = 0.05 + (agility - 10) * 0.002
```

---

## 2. Система стамины (Stamina System)

### Основные параметры:
- **Начальная стамина:** 30
- **Регенерация:** +1 в секунду
- **Стоимость тапа:** 1 + thornsTaken (урон от шипов)

### Формула максимальной стамины:
```
maxStamina = max(30, floor(maxHealth * 10))
```

### Логика:
1. Каждый тап тратит стамину
2. Если стамины недостаточно → срабатывает **Exhaustion**
3. Стамина регенерируется автоматически (+1/сек)
4. Во время Exhaustion регенерация приостанавливается

---

## 3. Механика шипов (Thorns / Обратка босса)

### Описание:
Боссы наносят "обратный урон" игроку при каждом ударе. Этот урон не убивает героя, а тратит его стамину.

### Формула (softcap):
```
thornsTaken = ceil(rawThorns * 100 / (100 + pDef))
```

Где:
- `rawThorns` - базовый урон шипов босса
- `pDef` - физическая защита игрока

### Пример:
- Boss thornsDamage = 10
- Player pDef = 40
- thornsTaken = ceil(10 * 100 / 140) = ceil(7.14) = 8

### Стоимость тапа с учётом шипов:
```
staminaCost = 1 + thornsTaken
```

### Значения thornsDamage для боссов:
| Босс | thornsDamage |
|------|--------------|
| Lizard | 0 |
| Golem | 1 |
| Spider Queen | 2 |
| Werewolf | 3 |
| Demon | 4 |
| Kraken | 5 |
| Dragon | 6 |
| Hydra | 8 |
| Phoenix | 10 |
| Ancient Dragon | 15 |

---

## 4. Система истощения (Exhaustion)

### Триггер:
Когда игрок пытается атаковать, но стамины недостаточно.

### Параметры:
- **Длительность:** 5 секунд
- **Эффект:** Игрок не может атаковать
- **Регенерация:** Приостановлена на время истощения

### Логика:
```javascript
if (stamina < staminaCostPerTap) {
  exhaustedUntil = Date.now() + 5000; // 5 сек
  // Игрок не может тапать до окончания exhaustion
}
```

### UI индикация:
- Красная полоса стамины
- Надпись "EXHAUSTED"
- Пульсирующая анимация

---

## 5. Расчёт урона (Damage Calculation)

### Базовый урон:
```
baseDamage = physicalPower * (1 + variance)
variance = ±20% случайный разброс
```

### С учётом защиты:
```
defReduction = defense / (defense + 100)
damage = rawDamage * (1 - defReduction * 0.5)
```

### Криты:
```
critChance = 0.05 + (agility - 10) * 0.002  // max 0.5
critMultiplier = 2.0
if (random < critChance) damage *= critMultiplier
```

---

## 6. Интервал авто-атаки

### Формула:
```
interval = 300000 / attackSpeed  // в миллисекундах
минимум = 250ms
```

### Примеры:
- attackSpeed 300 → interval 1000ms (1 атака/сек)
- attackSpeed 600 → interval 500ms (2 атаки/сек)
- attackSpeed 1200 → interval 250ms (4 атаки/сек, максимум)

---

## 7. Оффлайн-прогресс

### Ограничения:
- **Максимум:** 4 часа
- **Минимум для награды:** 1 минута

### Расчёт:
```
attacks = offlineSeconds * (1000 / attackInterval)
totalDamage = attacks * physicalPower
adenaEarned = floor(totalDamage / 100)
expEarned = floor(totalDamage / 50)
```

---

## 8. Socket события

### Новые события (Server → Client):

#### hero:exhausted
```typescript
{
  until: number;     // timestamp окончания
  duration: number;  // длительность в мс (5000)
}
```

#### combat:tick (для авто-атаки)
```typescript
{
  damage: number;
  stamina: number;
  maxStamina: number;
  thornsTaken: number;
  sessionDamage: number;
}
```

### Обновлённые события:

#### tap:result (добавлены поля)
```typescript
{
  // ... существующие поля
  stamina: number;
  maxStamina: number;
  thornsTaken: number;
  staminaCost: number;
}
```

---

## 9. Phaser интеграция

### Структура файлов:
```
src/game/
├── config.ts         # Конфигурация Phaser
├── index.ts          # Экспорты
└── scenes/
    └── BattleScene.ts  # Боевая сцена
```

### BattleScene включает:
- Отображение босса с анимациями
- HP бар босса (сверху)
- Stamina бар игрока (снизу)
- Floating damage numbers
- Exhaustion overlay
- Shake/flash эффекты при ударах

### PhaserGame.tsx:
React wrapper для интеграции Phaser с Next.js и Socket.io.

---

## 10. База данных (Prisma Schema)

### Новые поля User:
```prisma
// L2 Core Attributes
power           Int      @default(10)
agility         Int      @default(10)
vitality        Int      @default(10)
intellect       Int      @default(10)
spirit          Int      @default(10)

// L2 Derived Stats
physicalPower   Int      @default(15)
maxHealth       Int      @default(100)
physicalDefense Int      @default(40)

// Stamina System
stamina         Int      @default(30)
maxStamina      Int      @default(30)
lastStaminaTick DateTime @default(now())
exhaustedUntil  DateTime?
```

### Новые поля Boss:
```prisma
thornsDamage Int @default(0)
```

---

## Файлы в этой папке:

| Файл | Описание |
|------|----------|
| `StatsService.js` | Все L2 формулы расчёта статов |
| `schema.prisma` | Схема базы данных с новыми полями |
| `BattleScene.ts` | Phaser сцена боя |
| `config.ts` | Конфигурация Phaser |
| `PhaserGame.tsx` | React обёртка для Phaser |
| `events.ts` | TypeScript типы socket событий |

---

## Быстрый старт

```bash
# 1. Запустить PostgreSQL
docker run -d --name worldboss-db \
  -e POSTGRES_USER=worldboss \
  -e POSTGRES_PASSWORD=password \
  -e POSTGRES_DB=worldboss \
  -p 5432:5432 postgres:15

# 2. Применить схему
cd apps/web && npx prisma db push

# 3. Запустить проект
pnpm dev
```
